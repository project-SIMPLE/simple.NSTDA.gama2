<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Setup Â· GAMA Coins</title>
  <link href="/static/vendor/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background:#f5f7fa; }
    .card { border-radius:1rem; box-shadow:0 2px 8px rgba(0,0,0,.08); }

    /* --- Coins row layout --- */
    .coin-row { display:flex; align-items:center; flex-wrap:wrap; gap:.5rem .75rem; }
    .team-label { width:90px; }
    .spin { width:2.2rem; }
    .num  { width:5.5rem; text-align:center; }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance:none; margin:0; }
    input[type=number] { appearance:textfield; }

    /* --- Link row layout --- */
    .muted-link { pointer-events:none; opacity:.6; }
    .link-line { display:flex; gap:.5rem; }
    .link-url  { max-width:100%; }
    .link-url a { word-break:break-all; }
    .btns-right { display:flex; gap:.5rem; }

    /* QR box */
    .qr-wrap { display:none; }
    .qr-wrap.active { display:block; }
    .qr-box { background:#fff; border:1px solid #e5e7eb; border-radius:.5rem; padding:.75rem; }
    .qr-meta { font-size:.875rem; }

    /* ===== Mobile tweaks ===== */
    @media (max-width:576px){
      .team-label{ width:72px; }
      .spin{ width:2.6rem; padding:.45rem 0; }
      .num{ width:5rem; font-size:1.05rem; }
      .link-line{ flex-direction:column; align-items:stretch; }
      .btns-right{ width:100%; justify-content:flex-start; }
    }
    @media (min-width:768px){
      .link-line{ align-items:center; }
      .btns-right{ margin-left:auto; }
    }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="card p-4">
    <h2 class="mb-3">Setup Â· GAMA Coins ðŸª™</h2>

    <!-- Top controls -->
    <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
      <h5 class="mb-0 me-auto">Coins per team</h5>
    </div>

    <div id="rows" class="vstack gap-2 mb-3" role="group" aria-label="Coins per team"></div>

    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mt-2">
      <small id="statusText" class="text-muted">
        Enter coins (at least one team &gt; 0), then click <strong>Submit</strong> to unlock team links.
      </small>
      <div class="d-flex gap-2">
        <button id="resetAllBtn" class="btn btn-outline-danger">Reset all to zero</button>
        <button id="submitBtn" class="btn btn-success" disabled>Submit</button>
      </div>
    </div>

    <hr class="my-4"/>

    <h6 class="mb-2">Team links (fixed)</h6>
    <p class="text-muted small mb-2">
      Links will be available after you click <strong>Submit</strong> (or if the server already has coins).
      Use <em>Open</em>, <em>Copy</em>, or <em>QR</em>.
    </p>
    <div id="links" class="vstack gap-3"></div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toasts"></div>
<script src="/static/vendor/bootstrap.bundle.min.js"></script>
<script src="/static/vendor/qrcode.min.js"></script>

<script>
/* ---------- Constants & elements ---------- */
const teams = ["Blue","Red","Green","Yellow","Black","White"];
const rows      = document.getElementById('rows');
const linksBox  = document.getElementById('links');
const submitBtn = document.getElementById('submitBtn');
const resetAllBtn = document.getElementById('resetAllBtn');
const statusTxt = document.getElementById('statusText');

const toasts = document.getElementById("toasts");
function showToast(msg, variant="primary") {
  const el = document.createElement("div");
  el.className = `toast align-items-center text-bg-${variant} border-0`;
  el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  toasts.appendChild(el);
  new bootstrap.Toast(el, { delay: 1800 }).show();
  el.addEventListener("hidden.bs.toast", () => el.remove());
}

/* ---------- Utils ---------- */
const saving = { busy:false };
function setBusy(on){
  saving.busy = !!on;
  submitBtn.disabled = on || submitBtn.disabled;
  resetAllBtn.disabled = on;
  // disable all inputs when busy
  refs.forEach(({num, incBtn, decBtn}) => { num.disabled = on; incBtn.disabled = on; decBtn.disabled = on; });
}

function buildTeamUrl(team){
  // robust to proxy/prefix (always absolute to current origin)
  const u = new URL('/static/team.html', window.location.origin);
  u.searchParams.set('team', team);
  return u.toString();
}

/* ---------- Copy helper ---------- */
async function copyText(txt) {
  try {
    if (navigator.clipboard && window.isSecureContext) await navigator.clipboard.writeText(txt);
    else {
      const ta = document.createElement("textarea");
      ta.value = txt; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta); ta.focus(); ta.select();
      document.execCommand("copy"); ta.remove();
    }
    showToast("Link copied.", "success");
  } catch { showToast("Copy failed.", "danger"); }
}

/* ---------- Server API ---------- */
async function fetchAllCoins() {
  try {
    const res = await fetch("/api/coins", { cache:"no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  } catch {
    showToast("Failed to fetch coins from server.", "danger");
    return null;
  }
}
async function saveAllCoins(payload) {
  try {
    const res = await fetch("/api/coins", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  } catch {
    showToast("Failed to save coins to server.", "danger");
    return null;
  }
}

/* ---------- Build coin rows ---------- */
const refs = [];
function clampNonNegInt(v){ v = parseInt(v ?? "0", 10); return Number.isFinite(v) && v > 0 ? v : (v===0 ? 0 : 0); }

function makeRow(team, initial=0){
  const row = document.createElement('div');
  row.className = "coin-row";
  const inputId = `coins-${team}`;
  row.innerHTML = `
    <label class="team-label" for="${inputId}">${team}:</label>
    <button class="btn btn-outline-secondary spin" data-op="dec" aria-label="Decrease ${team} coins">âˆ’</button>
    <input id="${inputId}" class="form-control num" type="number" min="0" step="1" value="${clampNonNegInt(initial)}"
           aria-label="${team} coins" placeholder="0" inputmode="numeric" pattern="[0-9]*" autocomplete="off"/>
    <button class="btn btn-primary spin" data-op="inc" aria-label="Increase ${team} coins">+</button>
  `;
  const dec = row.querySelector('[data-op="dec"]');
  const inc = row.querySelector('[data-op="inc"]');
  const num = row.querySelector('input');

  const sanitize = () => {
    const v = clampNonNegInt(num.value);
    num.value = String(v);
    validateAnyPositive();
  };
  num.addEventListener('input', sanitize);
  num.addEventListener('blur', sanitize);
  num.addEventListener('keydown', (e)=>{ if(e.key==="Enter"){ e.preventDefault(); if(!submitBtn.disabled) submitBtn.click(); }});
  dec.onclick = () => { if (saving.busy) return; num.value = String(Math.max(0, clampNonNegInt(num.value)-1)); validateAnyPositive(); };
  inc.onclick = () => { if (saving.busy) return; num.value = String(Math.max(0, clampNonNegInt(num.value)+1)); validateAnyPositive(); };

  rows.appendChild(row);
  refs.push({ team, num, incBtn: inc, decBtn: dec });
}

/* ---------- Team links ---------- */
function badgeClass(t){
  switch(t){
    case "Blue": return "text-bg-primary";
    case "Red": return "text-bg-danger";
    case "Green": return "text-bg-success";
    case "Yellow": return "text-bg-warning";
    case "Black": return "text-bg-dark";
    case "White": return "text-bg-light text-dark";
    default: return "text-bg-secondary";
  }
}
function renderTeamLinks(enabled=false) {
  linksBox.innerHTML = "";
  teams.forEach(t => {
    const url = buildTeamUrl(t);
    const row = document.createElement('div');
    row.className = "vstack gap-2";

    const line = document.createElement('div');
    line.className = "link-line";
    line.innerHTML = `
      <div class="link-url text-truncate">
        <span class="badge me-2 ${badgeClass(t)}">${t}</span>
        <a class="link-primary text-truncate ${enabled ? '' : 'muted-link'}"
           href="${enabled ? url : '#'}" target="_blank" rel="noopener">${url}</a>
      </div>
      <div class="btns-right">
        <button class="btn btn-sm btn-outline-secondary" data-copy ${enabled ? '' : 'disabled'}>Copy</button>
        <button class="btn btn-sm btn-outline-primary"  data-open ${enabled ? '' : 'disabled'}>Open</button>
        <button class="btn btn-sm btn-outline-dark"     data-qr   ${enabled ? '' : 'disabled'}>QR</button>
      </div>
    `;

    const qrWrap = document.createElement('div');
    qrWrap.className = "qr-wrap";
    qrWrap.innerHTML = `
      <div class="qr-box d-flex flex-wrap align-items-center gap-3">
        <div class="qr-holder" aria-label="QR code for ${t}"></div>
        <div class="qr-meta">
          <div><strong>${t}</strong> QR</div>
          <div class="text-muted small text-break">${url}</div>
          <div class="mt-2">
            <button class="btn btn-sm btn-outline-success" data-dl>Download PNG</button>
            <button class="btn btn-sm btn-outline-secondary" data-hide>Hide</button>
          </div>
        </div>
      </div>
    `;

    const copyBtn = line.querySelector("[data-copy]");
    const openBtn = line.querySelector("[data-open]");
    const qrBtn   = line.querySelector("[data-qr]");
    const dlBtn   = qrWrap.querySelector("[data-dl]");
    const hideBtn = qrWrap.querySelector("[data-hide]");
    const holder  = qrWrap.querySelector(".qr-holder");

    copyBtn.onclick = () => copyText(url);
    openBtn.onclick = () => window.open(url, "_blank", "noopener");
    qrBtn.onclick = () => {
      if (typeof window.QRCode === "undefined") {
        showToast("QR library is not available.", "danger");
        document.querySelectorAll('[data-qr]').forEach(b => b.disabled = true);
        return;
      }
      if (qrWrap.classList.contains("active")) { qrWrap.classList.remove("active"); return; }
      holder.innerHTML = "";
      try {
        new QRCode(holder, { text:url, width:180, height:180, colorDark:"#000", colorLight:"#fff", correctLevel:QRCode.CorrectLevel.M });
        qrWrap.classList.add("active");
      } catch { showToast("Failed to generate QR.", "danger"); }
    };
    hideBtn.onclick = () => qrWrap.classList.remove("active");
    dlBtn.onclick = () => {
      const img = holder.querySelector("img");
      const canvas = holder.querySelector("canvas");
      const dataURL = img?.src || (canvas && canvas.toDataURL("image/png"));
      if (!dataURL) { showToast("No QR image to download yet.", "warning"); return; }
      const a = document.createElement("a"); a.href = dataURL; a.download = `team-${t}.png`; document.body.appendChild(a); a.click(); a.remove();
    };

    row.appendChild(line);
    row.appendChild(qrWrap);
    linksBox.appendChild(row);
  });
}

/* ---------- Validation & Submit ---------- */
function anyPositive(){ return refs.some(({num}) => clampNonNegInt(num.value) > 0); }
function validateAnyPositive(){
  if (saving.busy) return; // à¸­à¸¢à¹ˆà¸²à¸à¸£à¸°à¸žà¸£à¸´à¸šà¸ªà¸–à¸²à¸™à¸°à¸•à¸­à¸™à¸à¸³à¸¥à¸±à¸‡ save
  const ok = anyPositive();
  submitBtn.disabled = !ok;
  statusTxt.textContent = ok ? "Ready to submit." : "Enter coins (at least one team > 0), then click Submit to unlock team links.";
  statusTxt.classList.toggle("text-success", ok);
  statusTxt.classList.toggle("text-muted", !ok);
}

submitBtn.onclick = async () => {
  if (saving.busy) return;
  if (!anyPositive()) { showToast("Please enter coins for at least one team (> 0).", "warning"); return; }
  const payload = {};
  refs.forEach(({team, num}) => payload[team] = clampNonNegInt(num.value));
  setBusy(true);
  const res = await saveAllCoins(payload);
  setBusy(false);
  if (!res) return;
  renderTeamLinks(true);
  showToast("Saved successfully.", "success");
  statusTxt.textContent = "Coins saved on server. You can now Open/Copy/QR each team.";
  statusTxt.classList.remove("text-muted");
  statusTxt.classList.add("text-success");
};

/* ---------- Reset all to zero ---------- */
resetAllBtn.onclick = async () => {
  if (saving.busy) return;
  if (!confirm("Reset ALL teams to zero?")) return;
  const zeros = Object.fromEntries(teams.map(t => [t, 0]));
  setBusy(true);
  const res = await saveAllCoins(zeros);
  setBusy(false);
  if (!res) return;
  refs.forEach(r => r.num.value = "0");
  validateAnyPositive();
  renderTeamLinks(false);
  showToast("All teams reset to zero.", "warning");
  statusTxt.textContent = "All coins are zero. Enter new values and Submit to unlock links.";
  statusTxt.classList.remove("text-success");
  statusTxt.classList.add("text-muted");
};

/* ---------- Init flow ---------- */
(async function init(){
  const loading = document.createElement("div");
  loading.className = "text-muted small";
  loading.textContent = "Loading coins from serverâ€¦";
  rows.appendChild(loading);

  const coinsMap = (await fetchAllCoins()) || Object.fromEntries(teams.map(t => [t, 0]));
  rows.innerHTML = "";

  teams.forEach(t => makeRow(t, clampNonNegInt(coinsMap[t])));
  validateAnyPositive();

  const hasAny = Object.values(coinsMap).some(v => clampNonNegInt(v) > 0);
  renderTeamLinks(hasAny);
  if (hasAny) {
    statusTxt.textContent = "Server already has coins. You can Open/Copy/QR each team.";
    statusTxt.classList.remove("text-muted");
    statusTxt.classList.add("text-success");
  }
})();
</script>
</body>
</html>