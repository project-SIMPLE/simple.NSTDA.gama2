<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Team | GAMA Control</title>
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/> -->
  <link href="/static/vendor/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background:#f5f7fa; }
    .card { border-radius:1rem; box-shadow:0 2px 8px rgba(0,0,0,.08); }

    /* ---------- Header layout: responsive grid ---------- */
    .header-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: .75rem;
    }
    @media (min-width: 768px) {
      .header-grid {
        grid-template-columns: auto auto;
        align-items: center;
        justify-content: start;
        column-gap: 1rem;
      }
    }

    /* Team box */
    #teamFrame {
      border: 3px solid;
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .team-name {
      margin: 0;
      font-size: clamp(1.25rem, 6vw, 2rem);
      line-height: 1.15;
    }

    /* Status box */
    .status-box {
      display: inline-flex;
      align-items: center;
      gap: .6rem;
    }
    @media (max-width: 767.98px) {
      .status-box {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: .5rem;
      }
      #reconn { width: 100%; }
    }

    /* Action buttons */
    .actions { display: grid; gap: .5rem; }
    @media (min-width: 768px) {
      .actions { display: flex; gap: .5rem; flex-wrap: wrap; }
      .actions .btn { min-width: 14rem; }
    }
    .btn .icon { font-size: 1.15em; line-height: 1; margin-right: .35rem; }
    .coins-line { display:flex; align-items:center; gap:.5rem; }

    /* Chart box */
    #scoreChart { width: 100%; height: 260px; }
  </style>
  <!-- ECharts (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
<div class="container py-4">
  <div class="card p-4">

    <!-- ========== Header ========== -->
    <div class="header-grid mb-2">
      <div id="teamFrame" class="p-3">
        <h3 id="teamTitle" class="team-name">Team</h3>
      </div>

      <div class="status-box">
        <span class="fw-semibold">Status:</span>
        <span id="badge" class="badge text-bg-secondary">Disconnected</span>
        <button id="reconn" class="btn btn-outline-primary" disabled>Re-connect</button>
      </div>
    </div>

    <hr/>

    <!-- ========== Coins ========== -->
    <div class="coins-line mb-3">
      <span class="fw-semibold">Coins:</span>
      <span id="coins" class="badge text-bg-dark">0</span>
    </div>

    <!-- ========== Actions ========== -->
    <div class="actions mb-2">
      <button class="btn btn-danger"  id="btn_fire"><span class="icon">üî•</span>Reset Fire (cost 3)</button>
      <button class="btn btn-warning" id="btn_alien"><span class="icon">üëΩ</span>Reset Alien (cost 2)</button>
      <button class="btn btn-success" id="btn_grass"><span class="icon">üåø</span>Reset Grass (cost 1)</button>
    </div>

    <!-- ========== Scores Chart (NEW) ========== -->
    <div id="scoreChart" class="mt-3"></div>

  </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm reset</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-1">Threat: <strong id="cfThreat">-</strong></p>
        <p class="mb-1">Cost: <span class="badge text-bg-dark" id="cfCost">0</span></p>
        <p class="text-muted small mb-0">Your coins: <span id="cfCoins">0</span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="cfConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toasts"></div>
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> -->
<script src="/static/vendor/bootstrap.bundle.min.js"></script>

<script>
/* -------- Team -------- */
const qp   = new URLSearchParams(location.search);
const TEAM = qp.get("team") || "Unknown";
document.getElementById("teamTitle").textContent = `Team ${TEAM}`;

/* -------- Buttons & Costs -------- */
const btnFire  = document.getElementById("btn_fire");
const btnAlien = document.getElementById("btn_alien");
const btnGrass = document.getElementById("btn_grass");
const reconnBtn= document.getElementById("reconn");
const badge    = document.getElementById("badge");
const coinsEl  = document.getElementById("coins");
const COST     = { Fire:3, Alien:2, Grass:1 };

/* Team frame color */
const TEAM_COLOR = {
  Blue:   "#1d4ed8",
  Red:    "#dc2626",
  Green:  "#16a34a",
  Yellow: "#eab308",
  Black:  "#111827",
  White:  "#9ca3af"
};
const frame = document.getElementById("teamFrame");
frame.style.borderColor = TEAM_COLOR[TEAM] || "#6c757d";

/* -------- Server coins (no localStorage) -------- */
let coinsLoaded = false;
let currentCoins = 0;

function setCoins(val){
  currentCoins = Math.max(0, val|0);
  coinsEl.textContent = String(currentCoins);
  updateActionButtons();
}

async function fetchCoins(){
  try {
    const res = await fetch(`/api/coins/${encodeURIComponent(TEAM)}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    setCoins(data.coins ?? 0);
    coinsLoaded = true;
  } catch (e) {
    showToast("Failed to load coins from server.", "danger");
    coinsLoaded = false;
    setCoins(0);
  } finally {
    updateActionButtons();
  }
}

/* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ decrement ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå */
async function decrementCoins(cost, action){
  const res = await fetch("/api/coins/decrement", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ team: TEAM, cost, action })
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  if (data && typeof data.coins !== "undefined") {
    setCoins(data.coins);
  }
  return data;
}

/* refund endpoint */
async function refundCoins(amount){
  try {
    const res = await fetch("/api/coins/refund", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ team: TEAM, amount })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (data && typeof data.coins !== "undefined") setCoins(data.coins);
    return data;
  } catch(e){
    showToast("Refund failed, please sync.", "warning");
    return null;
  }
}

/* -------- Toasts -------- */
const toasts = document.getElementById("toasts");
function showToast(msg, variant="primary") {
  const el = document.createElement("div");
  el.className = `toast align-items-center text-bg-${variant} border-0`;
  el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  toasts.appendChild(el);
  const t = new bootstrap.Toast(el, { delay: 2200 }); t.show();
  el.addEventListener("hidden.bs.toast", () => el.remove());
}

/* -------- ECharts: init + updater (NEW) -------- */
const BAR_LABELS = ['Qu','Sa','Ma','Pho','De','Di','Os','Phy','Ca','Gm'];
let chart = null;

function ensureChart(){
  if (chart) return;
  chart = echarts.init(document.getElementById('scoreChart'));
  window.addEventListener('resize', () => chart && chart.resize());

  const zeros = new Array(BAR_LABELS.length).fill(0);

  chart.setOption({
    animation: true,
    animationDuration: 300,
    animationEasing: 'cubicOut',
    animationDurationUpdate: 500,
    animationEasingUpdate: 'cubicOut',

    grid: { left: 40, right: 12, top: 20, bottom: 35 },
    tooltip: {
      trigger: 'item',
      formatter: params => `${params.name}: ${params.value}`
    },
    xAxis: {
      type: 'category',
      data: BAR_LABELS,
      axisTick: { alignWithLabel: true },
      axisLabel: { rotate: 90 }
    },
    yAxis: {
      type: 'value',
      min: 0,
      max: 10,
      interval: 1
    },
    series: [{
      type: 'bar',
      data: zeros,
      itemStyle: { color: (TEAM_COLOR[TEAM] || '#6c757d') },
      universalTransition: true,
      animation: true,
      animationDurationUpdate: 500,
      animationEasingUpdate: 'cubicOut'
    }]
  });
}

function updateChart(scores){
  ensureChart();
  const data = BAR_LABELS.map((_, i) => {
    const v = Number(scores[i]);
    const n = Number.isFinite(v) ? Math.round(v) : 0;
    return Math.max(0, Math.min(10, n));
  });

  chart.setOption({
    series: [{
      animation: true,
      animationDurationUpdate: 500,
      animationEasingUpdate: 'cubicOut',
      data
    }]
  });
}

/* -------- parse {team=Blue, score=[...]} (NEW) -------- */
function parseGamaKVMessage(s){
  if (typeof s !== "string") return null;
  const t = s.trim();
  if (!t.startsWith("{") || !t.endsWith("}") || !t.includes("=")) return null;

  const mTeam = /team\s*=\s*([A-Za-z]+)/i.exec(t);
  const team = mTeam ? mTeam[1] : null;

  const mScores = /scores?\s*=\s*\[([^\]]*)\]/i.exec(t);
  let scores = [];
  if (mScores && mScores[1]) {
    scores = mScores[1]
      .split(",")
      .map(x => parseFloat(x.trim()))
      .filter(n => !Number.isNaN(n));
  }
  if (!team || !scores.length) return null;
  return { type: "score_update", team, scores };
}

/* -------- WS state -------- */
let sock = null;
let bridgeReady = false; // Browser ‚Üî Bridge
let gamaReady   = false; // Bridge ‚Üî GAMA

const STATUS = { DISCONNECTED:"Disconnected", CONNECTING:"Connecting", WAITING:"Waiting GAMA", CONNECTED:"Connected" };
function setBadge(text, cls){ badge.textContent = text; badge.className = "badge text-bg-" + cls; }
function isSockOpen(){ return sock && sock.readyState === 1; }

/* Enable/disable + color buttons by coins & connection */
function updateActionButtons(){
  const canSend = gamaReady && isSockOpen();
  const setBtnState = (btn, baseClass, cost) => {
    const enough = currentCoins >= cost;
    const on = canSend && coinsLoaded && enough;
    btn.disabled = !on;
    btn.classList.remove("btn-secondary","btn-danger","btn-warning","btn-success");
    btn.classList.add(on ? baseClass : "btn-secondary");
  };
  setBtnState(btnFire,  "btn-danger",  COST.Fire);
  setBtnState(btnAlien, "btn-warning", COST.Alien);
  setBtnState(btnGrass, "btn-success", COST.Grass);

  reconnBtn.disabled = isSockOpen();
}

function refreshUI(){
  if (!bridgeReady) { setBadge(STATUS.DISCONNECTED, "secondary"); }
  else if (bridgeReady && !gamaReady){ setBadge(STATUS.WAITING, "warning"); }
  else if (bridgeReady && gamaReady){ setBadge(STATUS.CONNECTED, "success"); }
  updateActionButtons();
}

/* WS connect */
function connectWS(){
  if (isSockOpen()) return;
  bridgeReady = false; gamaReady = false; refreshUI();
  showToast("Connecting to bridge...", "secondary");

  const scheme = location.protocol === "https:" ? "wss://" : "ws://";
  const url = scheme + location.host + "/ws";
  sock = new WebSocket(url);

  sock.onopen = () => {
    bridgeReady = true; gamaReady = false;
    showToast("Bridge connected. Waiting for GAMA...", "info");
    refreshUI();
  };
  sock.onclose = () => {
    bridgeReady = false; gamaReady = false;
    showToast("Disconnected", "secondary");
    refreshUI();
  };
  sock.onerror = () => {
    bridgeReady = false; gamaReady = false;
    showToast("Connection error", "danger");
    refreshUI();
  };
  sock.onmessage = (e) => {
    // 1) ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse JSON ‡∏Å‡πà‡∏≠‡∏ô
    let obj = null;
    try { obj = JSON.parse(e.data); } catch {}

    // 2) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON ‡∏•‡∏≠‡∏á parse ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö {team=Blue, score=[...]}
    if (!obj) obj = parseGamaKVMessage(e.data);

    // --- NEW: real-time coins broadcast from server ---
    if (obj && obj.type === "coins_update") {
      if (obj.team === TEAM && typeof obj.coins === "number") {
        setCoins(obj.coins);              // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      }
      return; // ‡∏à‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏´‡∏•‡∏ï‡πà‡∏≠
    }
    // ---------------------------------------------------

    // 3) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô score_update ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‚Üí ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
    if (obj && obj.type === "score_update" && obj.team === TEAM && Array.isArray(obj.scores)) {
      updateChart(obj.scores);
      return;
    }

    // 4) ‡πÄ‡∏î‡∏¥‡∏°: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ bridge/GAMA
    try {
      if (obj?.error === "gama_unreachable") {
        gamaReady = false;
        showToast("GAMA not reachable. Retrying...", "warning");
        refreshUI();
        return;
      }
      if (obj?.info === "gama_connected") {
        gamaReady = true;
        showToast("Bridge connected to GAMA", "success");
        refreshUI();
        return;
      }
    } catch { /* normal string from GAMA */ }
  };
}

/* -------- Confirm Modal -------- */
const confirmModalEl = document.getElementById('confirmModal');
const confirmModal   = new bootstrap.Modal(confirmModalEl);
const cfThreatEl     = document.getElementById('cfThreat');
const cfCostEl       = document.getElementById('cfCost');
const cfCoinsEl      = document.getElementById('cfCoins');
const cfConfirmBtn   = document.getElementById('cfConfirmBtn');
let pending = null;

function openConfirm(threat, cost){
  pending = { threat, cost };
  cfThreatEl.textContent = threat;
  cfCostEl.textContent   = String(cost);
  cfCoinsEl.textContent  = String(currentCoins);
  confirmModal.show();
}

/* -------- Actions -------- */
function sendReset(threat){
  if (!gamaReady || !isSockOpen()) { showToast("Not connected to GAMA", "warning"); return false; }
  const msg = `type=RemoveThreat;team=${TEAM};threat=${threat}`;
  try { sock.send(msg); showToast(`Sent reset "${threat}"`, "info"); return true; }
  catch { showToast("Failed to send", "danger"); return false; }
}

/* decrement ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡πà‡∏á‡πÑ‡∏õ GAMA; ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÉ‡∏´‡πâ refund */
cfConfirmBtn.onclick = async () => {
  if (!pending) return;
  const { threat, cost } = pending;

  let dec;
  try {
    dec = await decrementCoins(cost, threat);
  } catch(e){
    showToast("Failed to update coins on server.", "danger");
    return;
  }

  if (!dec?.ok){
    const serverCoins = typeof dec?.coins === "number" ? dec.coins : currentCoins;
    showToast(`Not enough coins. You have ${serverCoins}.`, "warning");
    return;
  }

  const sent = sendReset(threat);
  if (!sent){
    await refundCoins(cost);
    showToast("Action failed. Refunded coins.", "warning");
    return;
  }

  showToast(`Coins deducted (-${cost}). Remaining: ${currentCoins}`, "success");
  confirmModal.hide();
  pending = null;
};

/* Hook buttons */
btnFire.onclick  = () => openConfirm("Fire",    COST.Fire);
btnAlien.onclick = () => openConfirm("Aliens",  COST.Alien);
btnGrass.onclick = () => openConfirm("Grasses", COST.Grass);

/* -------- Init: load coins, open WS -------- */
(async function init(){
  await fetchCoins();   // ‡πÇ‡∏´‡∏•‡∏î‡∏¢‡∏≠‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
  connectWS();          // ‡∏ï‡πà‡∏≠ WS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö coins_update ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
  updateActionButtons();
  ensureChart();        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏£‡∏≤‡∏ü
})();
reconnBtn.onclick = () => { if (!isSockOpen()) connectWS(); };
</script>
</body>
</html>